<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Reset password akun DN Apps Anda">
    <title>Lupa Password - DN Apps</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/images/logo/favicon.svg">

    <!-- CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/pages/auth.css">
</head>

<body class="auth-page">
    <!-- Auth Container -->
    <div class="auth-container">
        <!-- Left Side - Branding -->
        <div class="auth-branding">
            <div class="auth-branding-content">
                <a href="index.html" class="logo">
                    <img src="assets/images/logo_dnapps.png" alt="DN Apps" class="logo-image">
                </a>
                <h1>Lupa Password?</h1>
                <p>Jangan khawatir! Masukkan email Anda dan kami akan mengirimkan link untuk reset password.</p>

                <div class="auth-features">
                    <div class="auth-feature">
                        <div class="auth-feature-icon">ðŸ“§</div>
                        <div class="auth-feature-text">
                            <h4>Cek Email Anda</h4>
                            <p>Link reset akan dikirim ke email terdaftar</p>
                        </div>
                    </div>
                    <div class="auth-feature">
                        <div class="auth-feature-icon">ðŸ”’</div>
                        <div class="auth-feature-text">
                            <h4>Aman & Terenkripsi</h4>
                            <p>Link hanya berlaku selama 1 jam</p>
                        </div>
                    </div>
                    <div class="auth-feature">
                        <div class="auth-feature-icon">âœ¨</div>
                        <div class="auth-feature-text">
                            <h4>Password Baru</h4>
                            <p>Buat password baru yang kuat</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side - Form -->
        <div class="auth-form-container">
            <div class="auth-form-wrapper">
                <div class="auth-form-header">
                    <h2>Reset Password</h2>
                    <p>Masukkan email yang terdaftar di akun Anda</p>
                </div>

                <!-- Success Message (hidden by default) -->
                <div id="successMessage"
                    style="display:none; background: var(--success-light, #d4edda); color: var(--success, #155724); padding: var(--space-4); border-radius: var(--radius-lg); margin-bottom: var(--space-6); text-align: center;">
                    <p style="margin:0"><strong>Email terkirim!</strong></p>
                    <p style="margin: var(--space-2) 0 0 0; font-size: var(--text-sm);">Silakan cek inbox email Anda
                        untuk link reset password.</p>
                </div>

                <!-- Forgot Password Form -->
                <form class="auth-form" id="forgotPasswordForm">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" placeholder="nama@email.com" required>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg btn-block">
                        Kirim Link Reset
                    </button>
                </form>

                <p class="auth-switch">
                    Sudah ingat password? <a href="login.html">Login</a>
                </p>
                <p class="auth-switch" style="margin-top: var(--space-2);">
                    Belum punya akun? <a href="signup.html">Daftar sekarang</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>

    <!-- JavaScript -->
    <script>
        // Redirect if already logged in
        redirectIfAuthenticated('dashboard.html');

        // Forgot Password Form submission
        document.getElementById('forgotPasswordForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            const successMessage = document.getElementById('successMessage');

            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Mengirim...';

            const email = document.getElementById('email').value;

            try {
                // Build the redirect URL - must be whitelisted in Supabase Dashboard
                const redirectUrl = window.location.origin + '/reset-password.html';
                console.log('--- RESET PASSWORD DEBUG ---');
                console.log('Target Redirect URL:', redirectUrl);
                console.log('Origin:', window.location.origin);

                const { data, error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: redirectUrl
                });

                console.log('Supabase Response:', { data, error });
                console.log('---------------------------');

                if (error) {
                    alert('Gagal mengirim email: ' + error.message);
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                } else {
                    // Show success message
                    this.style.display = 'none';
                    successMessage.style.display = 'block';

                    // Add extra tip in console
                    console.log('SUCCESS: Email request accepted by Supabase.');
                    console.log('NOTE: If you still don\'t receive the email:');
                    console.log('1. Check your spam folder.');
                    console.log('2. Ensure the redirect URL is whitelisted in Supabase Dashboard.');
                    console.log('3. Check Supabase Authentication logs.');
                }
            } catch (err) {
                console.error('Unexpected error:', err);
                alert('Terjadi kesalahan tidak terduga: ' + err.message);
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    </script>
</body>

</html>